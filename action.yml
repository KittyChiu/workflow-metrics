# This workflow evaluates actions execution time and outputs a job summary.
# It uses the `get_workflow_runs` Python script to call the GitHub API and retrieve workflow runs, which are output to runs.json.
# It then generates a list of workflow names from runs.json and outputs the results to workflow-names.txt.
# Finally, it evaluates workflow runs statistics using the `evaluate_workflow_runs` Python script, and outputs the results to workflow-stats.csv.
# The workflow also generates a Mermaid diagram and table in Markdown format for the report.
# The workflow is triggered by a manual workflow_dispatch event.
#
# Variations:
# - Workflow names can also be manually defined and ordered in the workflow-names.txt file.
# - `START_DATE` and `END_DATE` in `step: Set dates` - They are set to one month apart. This can be modified to the desired duration.
# - Templates in `step: Generate Mermaid diagram in markdown` and `step: Generate Mermaid diagram in markdown` can be customised with styling.
#
name: Workflow Metrics
description: Generate metrics for historical workflow runs
inputs:
  GH_TOKEN:
    description: 'Repository token for API calls'
    required: true
    default: ${{ github.events.inputs.GH_TOKEN }}
  REPO_NAME:
    description: 'Repository name'
    required: true
    default: ${{ github.event.inputs.REPO_NAME }}
  OWNER_NAME:
    description: 'Repository owner name'
    required: true
    default: ${{ github.event.inputs.OWNER_NAME }}
  START_DATE:
    description: 'Start date of the period to evaluate'
    required: true
    default: ${{ github.event.inputs.START_DATE }}
  END_DATE:
    description: 'End date of the period to evaluate'
    required: true
    default: ${{ github.event.inputs.END_DATE }}
  MERMAID_TEMPLATE_PATH:
    description: 'Mermaid markdown template'
    required: false
    default: ${{ github.event.inputs.MERMAID_TEMPLATE_PATH }}
  TABLE_TEMPLATE_PATH:
    description: 'Table markdown template'
    required: false
    default: ${{ github.event.inputs.TABLE_TEMPLATE_PATH }}

runs:
  using: composite
  steps:
    - name: Set environment variables
      run: |
        echo "GH_TOKEN=${{ github.events.inputs.GH_TOKEN }}" >> "$GITHUB_ENV"
        echo "REPO_NAME=${{ github.event.inputs.REPO_NAME }}" >> "$GITHUB_ENV"
        echo "OWNER_NAME=${{ github.event.inputs.OWNER_NAME }}" >> "$GITHUB_ENV"
        echo "START_DATE=${{ github.event.inputs.START_DATE }}" >> "$GITHUB_ENV"
        echo "END_DATE=${{ github.event.inputs.END_DATE }}" >> "$GITHUB_ENV"
        echo "MERMAID_TEMPLATE_PATH=${{ github.event.inputs.MERMAID_TEMPLATE_PATH }}" >> "$GITHUB_ENV"
        echo "TABLE_TEMPLATE_PATH=${{ github.event.inputs.TABLE_TEMPLATE_PATH }}" >> "$GITHUB_ENV"
      shell: bash

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
      shell: bash

    # Use the `get_workflow_runs` Python script to call GitHub API and output to runs.json
    - name: Get workflow runs
      run: |
        python get_workflow_runs.py ${{ env.REPOSITORY_OWNER }} ${{ env.REPOSITORY }} ${{ env.START_DATE }} ${{ env.END_DATE }}
        cat runs.json
      shell: bash

    # Generate list of workflow names from runs.json, OR define the Value Stream actions in workflow-names.txt and comment this step
    - name: Get list of workflow names from runs.json
      run: |
        jq '[.[] | .name ] | unique' runs.json | jq -r '.[]' > workflow-names.txt
        cat workflow-names.txt 
      shell: bash

    # Evaluate workflow runs statistics using `evaluate_workflow_runs` Python script, and output to workflow-stats.csv
    - name: Evaluate actions consumption
      run: |
        echo "Evaluating workflow runs statistics"
        python evaluate_workflow_runs.py 
        cat workflow-stats.csv
      shell: bash

    # # Generate Mermaid diagram in Markdown format 
    # - name: Generate Mermaid diagram in markdown
    #   run: |
    #     echo "## Value stream view" >> mermaid.md
    #     echo -e '```mermaid\n' >> mermaid.md
    #     echo "timeline" >> mermaid.md
    #     echo "    Stage: Average run duration : Success rate : Frequency" >> mermaid.md

    #     tail -n +2 workflow-stats.csv | while IFS=, read -r workflow_name average_duration percentage_success total_runs;
    #     do
    #       echo "Parse Mermaid diagram: Calculated event column"
    #       echo "    $workflow_name: $average_duration : $percentage_success : $total_runs" >> mermaid.md
    #     done
    #     echo -e '```\n' >> mermaid.md
    #   shell: bash

    # # Generate table in Markdown format 
    # - name: Generate Table in markdown
    #   run: |
    #     echo "## Consumption table view" >> table.md
    #     echo "| Workflow | Average duration | Success rate | Total runs |" >> table.md
    #     echo "| -------- | ---------------- | ------------ | ---------- |" >> table.md

    #     tail -n +2 workflow-stats.csv | while IFS=, read -r workflow_name average_duration percentage_success total_runs;
    #     do
    #       echo "Parse Table: Calculated row"
    #       echo "| $workflow_name \
    #       | $average_duration \
    #       | $percentage_success \
    #       | $total_runs \
    #       |" >> table.md
    #     done
    #   shell: bash

    # - name: Format calculated result with templates
    #   run: |
    #     echo "Combine output files"
    #     cat mermaid.md table.md > output.md
    #   shell: bash